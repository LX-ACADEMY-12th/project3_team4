<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team4.mywebapp.mapper.MinihomePageMapper">

  <select id="getMinihomePage" parameterType="int" resultType="com.team4.mywebapp.dto.MinihomePageDTO">
    SELECT
      m.minihome_id AS minihomeId,
      m.title AS title,
      m.background_color_id AS backgroundColor,
      m.applied_theme_id AS appliedThemeId,
      m.created_at AS createdAt,
      m.updated_at AS updatedAt,

      u.user_id AS userId,
      u.nickname AS nickname,
      u.profile_photo_path                       AS profileImage,
      u.today_mood                               AS todayMood,
      u.status_message                           AS statusMessage,
      u.birth_date                               AS birthDate,
      u.gender                                   AS gender,
      u.region                                   AS region,
      u.hobby                                    AS hobby,

      COALESCE((
        SELECT vs.daily_visitors
        FROM visit_stats vs
        WHERE vs.target_minihome_id = m.minihome_id
        ORDER BY vs.visited_at DESC
        LIMIT 1
      ), 0) AS todayCount,

      (SELECT COUNT(*)
       FROM visit_log vl
       WHERE vl.minihome_minihome_id = m.minihome_id) AS totalCount

    FROM minihome m
    JOIN user u ON m.minihome_owner_id = u.user_id
    WHERE m.minihome_owner_id = #{minihomeOwnerId}
  </select>

</mapper>